<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solmate VRM Loader</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #0a0e17;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        #canvas {
            width: 100%;
            height: 100vh;
            display: block;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            z-index: 100;
        }
        
        #controls {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            z-index: 100;
        }
        
        #error {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            color: #ff6b6b;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            display: none;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="loading">Loading VRM...</div>
    <div id="controls">
        <button onclick="loadVRM()">Reload VRM</button>
        <button onclick="testAnimation()">Test Animation</button>
    </div>
    <div id="error"></div>
    <canvas id="canvas"></canvas>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/",
            "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3.0.0/lib/three-vrm.module.js"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';
        
        let scene, camera, renderer, currentVRM, clock;
        
        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0e17);
            
            // Camera
            camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.1, 20);
            camera.position.set(0, 1.4, 3);
            
            // Renderer
            const canvas = document.getElementById('canvas');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMapping = THREE.LinearToneMapping;
            
            // Lights
            const light = new THREE.DirectionalLight(0xffffff, Math.PI);
            light.position.set(1, 1, 1);
            scene.add(light);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            // Clock for animations
            clock = new THREE.Clock();
            
            // Handle resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            
            animate();
        }
        
        async function loadVRM() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            
            // Remove existing VRM
            if (currentVRM) {
                scene.remove(currentVRM.scene);
                VRMUtils.deepDispose(currentVRM.scene);
            }
            
            const loader = new GLTFLoader();
            loader.register((parser) => {
                return new VRMLoaderPlugin(parser);
            });
            
            // Try multiple URLs
            const urls = [
                '/assets/avatar/solmate.vrm',
                'https://raw.githubusercontent.com/DirkDigglerTown/solmate/main/web/assets/avatar/solmate.vrm',
                // Fallback to a known working VRM for testing
                'https://cdn.jsdelivr.net/gh/pixiv/three-vrm@dev/packages/three-vrm-core/examples/models/VRM1_Constraint_Twist_Sample.vrm'
            ];
            
            let loaded = false;
            
            for (const url of urls) {
                if (loaded) break;
                
                console.log(`Trying to load VRM from: ${url}`);
                
                try {
                    const gltf = await loader.loadAsync(url);
                    const vrm = gltf.userData.vrm;
                    
                    if (vrm) {
                        // Rotate model 180 degrees to face camera
                        vrm.scene.rotation.y = Math.PI;
                        
                        // Add to scene
                        scene.add(vrm.scene);
                        currentVRM = vrm;
                        
                        // Setup VRM
                        vrm.humanoid?.getNormalizedBoneNode('hips')?.position.set(0, 0, 0);
                        
                        // Camera look at model
                        camera.lookAt(0, 1, 0);
                        
                        console.log('VRM loaded successfully from:', url);
                        loadingEl.style.display = 'none';
                        loaded = true;
                        
                        // Show what we loaded
                        console.log('VRM Info:', {
                            hasHumanoid: !!vrm.humanoid,
                            hasExpressionManager: !!vrm.expressionManager,
                            hasLookAt: !!vrm.lookAt,
                            hasMeta: !!vrm.meta
                        });
                    }
                } catch (error) {
                    console.error(`Failed to load from ${url}:`, error);
                }
            }
            
            if (!loaded) {
                errorEl.textContent = 'Failed to load VRM from all sources. Check console for details.';
                errorEl.style.display = 'block';
                loadingEl.style.display = 'none';
                
                // Create fallback cube
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshBasicMaterial({ color: 0xff6b6b });
                const cube = new THREE.Mesh(geometry, material);
                cube.position.y = 1;
                scene.add(cube);
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            const deltaTime = clock.getDelta();
            
            // Update VRM
            if (currentVRM) {
                currentVRM.update(deltaTime);
                
                // Simple idle animation
                const time = clock.elapsedTime;
                if (currentVRM.scene) {
                    currentVRM.scene.rotation.y = Math.PI + Math.sin(time * 0.5) * 0.1;
                }
            }
            
            renderer.render(scene, camera);
        }
        
        // Make functions global for button access
        window.loadVRM = loadVRM;
        window.testAnimation = function() {
            if (currentVRM && currentVRM.expressionManager) {
                // Test expressions
                const expressions = ['happy', 'angry', 'sad', 'surprised'];
                const expr = expressions[Math.floor(Math.random() * expressions.length)];
                
                currentVRM.expressionManager.setValue(expr, 1.0);
                setTimeout(() => {
                    currentVRM.expressionManager.setValue(expr, 0);
                }, 2000);
                
                console.log(`Playing expression: ${expr}`);
            } else {
                console.log('No expression manager available');
            }
        };
        
        // Initialize and load
        init();
        loadVRM();
    </script>
</body>
</html>
