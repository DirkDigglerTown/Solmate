<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solmate - Enhanced VRM Companion</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/assets/logo/solmatelogo.png">
  <link rel="icon" href="/assets/logo/solmatelogo.png">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header class="hud">
    <div class="left">
      <button id="themeToggle">üåô</button>
      <div class="pill ws" id="wsLight">
        WS OFF
      </div>
    </div>
    <div class="pill sol" id="solPrice">
      SOL ‚Äî
    </div>
    <div class="pill tps" id="networkTPS">
      ‚ù§Ô∏è
    </div>
  </header>
  
  <canvas id="vrmCanvas"></canvas>
  
  <div id="chatContainer" class="dock">
    <form id="chatForm">
      <input id="promptInput" type="text" class="ask" placeholder="Ask anything about Solana, crypto, or just vibe...">
      <select id="voiceSelect" class="sel">
        <option value="nova">Nova</option>
        <option value="alloy">Alloy</option>
        <option value="echo">Echo</option>
        <option value="fable">Fable</option>
        <option value="onyx">Onyx</option>
        <option value="shimmer">Shimmer</option>
      </select>
      <button id="sendBtn" class="send icon-btn">‚ñ∂</button>
      <button id="clearBtn" class="send icon-btn">üîá</button>
    </form>
  </div>
  
  <div id="debugOverlay" class="overlay hidden">
    <h3>Enhanced VRM Debug</h3>
    <ul>
      <li>Press Ctrl+D to toggle debug overlay</li>
      <li>Commands: debugVRM(), testExpressions(), sayHello()</li>
      <li>VRM file: 21MB with expressions & animations</li>
      <li>Robust CDN loading with fallbacks</li>
      <li>Full facial expressions and lip sync</li>
    </ul>
    <div id="overlayLogs"></div>
  </div>
  
  <!-- Loading indicator -->
  <div id="loadingStatus" style="
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    color: white; 
    font-family: Arial, sans-serif; 
    z-index: 1000;
    background: rgba(0,0,0,0.8);
    padding: 20px 30px;
    border-radius: 10px;
    text-align: center;
  ">
    üé≠ Loading Enhanced VRM System...
  </div>
  
  <!-- Robust library loading with fallbacks -->
  <script>
    // Robust library loader with multiple CDN fallbacks
    async function loadLibraries() {
      const updateStatus = (msg) => {
        const status = document.getElementById('loadingStatus');
        if (status) status.textContent = msg;
      };
      
      // Three.js sources (multiple versions for compatibility)
      const threeSources = [
        'https://unpkg.com/three@0.164.1/build/three.min.js',
        'https://unpkg.com/three@0.158.0/build/three.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/three.js/r164/three.min.js',
        'https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.min.js'
      ];
      
      // GLTF Loader sources
      const gltfSources = [
        'https://unpkg.com/three@0.164.1/examples/js/loaders/GLTFLoader.js',
        'https://unpkg.com/three@0.158.0/examples/js/loaders/GLTFLoader.js',
        'https://cdnjs.cloudflare.com/ajax/libs/three.js/r164/loaders/GLTFLoader.js'
      ];
      
      // VRM Library sources  
      const vrmSources = [
        'https://unpkg.com/@pixiv/three-vrm@2.1.3/lib/three-vrm.min.js',
        'https://unpkg.com/@pixiv/three-vrm@2.0.6/lib/three-vrm.min.js',
        'https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2.1.3/lib/three-vrm.min.js'
      ];
      
      async function loadScript(sources, name) {
        updateStatus(`Loading ${name}...`);
        
        for (const src of sources) {
          try {
            await new Promise((resolve, reject) => {
              const script = document.createElement('script');
              script.src = src;
              script.onload = resolve;
              script.onerror = reject;
              document.head.appendChild(script);
              
              // Timeout after 10 seconds
              setTimeout(() => reject(new Error('Timeout')), 10000);
            });
            
            console.log(`‚úÖ ${name} loaded from: ${src}`);
            return true;
          } catch (err) {
            console.warn(`‚ùå ${name} failed from ${src}:`, err.message);
            continue;
          }
        }
        
        throw new Error(`Failed to load ${name} from all sources`);
      }
      
      try {
        // Load Three.js
        await loadScript(threeSources, 'Three.js');
        
        // Verify Three.js loaded
        if (!window.THREE) {
          throw new Error('Three.js failed to initialize');
        }
        
        // Load GLTF Loader
        await loadScript(gltfSources, 'GLTF Loader');
        
        // Load VRM Library
        await loadScript(vrmSources, 'VRM Library');
        
        updateStatus('üé≠ Libraries loaded successfully!');
        
        // Load the main script
        const mainScript = document.createElement('script');
        mainScript.src = '/script.js';
        mainScript.onload = () => {
          updateStatus('üé≠ VRM System ready!');
        };
        mainScript.onerror = () => {
          updateStatus('‚ùå Main script failed to load');
        };
        document.head.appendChild(mainScript);
        
      } catch (error) {
        console.error('Library loading failed:', error);
        updateStatus('‚ùå Library loading failed - continuing with basic mode');
        
        // Load main script anyway (it has fallbacks)
        const mainScript = document.createElement('script');
        mainScript.src = '/script.js';
        document.head.appendChild(mainScript);
      }
    }
    
    // Start loading when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadLibraries);
    } else {
      loadLibraries();
    }
  </script>
</body>
</html>
